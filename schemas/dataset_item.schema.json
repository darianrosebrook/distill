{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Contextual Dataset Item Schema",
  "description": "Schema for contextual prompt dataset items with process-step supervision targets",
  "type": "object",
  "required": ["prompt", "teacher_text", "metadata"],
  "properties": {
    "prompt": {
      "type": "string",
      "description": "User prompt with CAWS header"
    },
    "teacher_text": {
      "type": "string",
      "description": "Teacher response text"
    },
    "metadata": {
      "type": "object",
      "required": [
        "dataset_version",
        "call_sequence",
        "scenario",
        "complexity",
        "structure",
        "expected_behaviour",
        "url_allowlist_ok",
        "caws_header_ok",
        "text_norm",
        "line_endings",
        "safety_scan",
        "lang"
      ],
      "properties": {
        "dataset_version": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$",
          "description": "Dataset schema version"
        },
        "sample_id": {
          "type": "string",
          "description": "Unique sample identifier"
        },
        "provenance": {
          "type": "object",
          "properties": {
            "seed": {
              "type": ["integer", "null"],
              "description": "Random seed used for generation"
            },
            "scenario": {
              "type": "string",
              "enum": ["file_ops", "web_search", "code_exec", "multi_step"]
            },
            "tags": {
              "type": "array",
              "items": {
                "type": "string",
                "enum": ["control", "adversarial", "multilingual", "long_context"]
              }
            }
          }
        },
        "call_sequence": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["name", "arguments"],
            "properties": {
              "name": {"type": "string"},
              "arguments": {"type": "object"}
            }
          }
        },
        "scenario": {
          "type": "string",
          "enum": ["file_ops", "web_search", "code_exec", "multi_step"]
        },
        "complexity": {
          "type": "string",
          "enum": ["single_call", "multi_call", "branching_error_recovery"]
        },
        "structure": {
          "type": "string",
          "enum": ["flat_args", "nested_args", "arrays", "enums", "numeric_ranges", "optional_keys"]
        },
        "expected_behaviour": {
          "type": "string",
          "enum": ["normal", "no_tool", "decline", "retry"]
        },
        "adversarial": {
          "type": "object",
          "properties": {
            "type": {
              "type": "string",
              "enum": ["malformed_json", "range_violation", "ambiguity", "timeout_retry"]
            },
            "expected": {"type": "string"}
          }
        },
        "language": {
          "type": "string",
          "enum": ["es", "de", "fr"]
        },
        "lang": {
          "type": "string",
          "enum": ["en", "es", "de", "fr"],
          "description": "Language tag (en for English, multilingual codes for others)"
        },
        "long_context": {
          "type": "boolean"
        },
        "url_allowlist_ok": {
          "type": "boolean"
        },
        "caws_header_ok": {
          "type": "boolean"
        },
        "text_norm": {
          "type": "string",
          "enum": ["NFC"],
          "description": "Text normalization format"
        },
        "line_endings": {
          "type": "string",
          "enum": ["LF"],
          "description": "Line ending format"
        },
        "safety_scan": {
          "type": "object",
          "required": ["urls_ok", "pii_hits"],
          "properties": {
            "urls_ok": {"type": "boolean"},
            "pii_hits": {"type": "integer", "minimum": 0}
          }
        },
        "tool_name_span_bytes": {
          "type": "array",
          "items": {"type": "integer"},
          "minItems": 2,
          "maxItems": 2,
          "description": "Single-call tool name span [start, end] (backward compatibility)"
        },
        "tool_name_spans_bytes": {
          "type": "array",
          "items": {
            "type": "array",
            "items": {"type": "integer"},
            "minItems": 2,
            "maxItems": 2
          },
          "description": "Multi-call tool name spans [[start0, end0], [start1, end1], ...]"
        },
        "json_args_span_bytes": {
          "type": "array",
          "items": {"type": "integer"},
          "minItems": 2,
          "maxItems": 2,
          "description": "Single-call JSON arguments span [start, end] (backward compatibility)"
        },
        "json_args_spans_bytes": {
          "type": "array",
          "items": {
            "type": "array",
            "items": {"type": "integer"},
            "minItems": 2,
            "maxItems": 2
          },
          "description": "Multi-call JSON arguments spans [[start0, end0], [start1, end1], ...]"
        },
        "json_pointer_name": {
          "type": "string",
          "pattern": "^/name$",
          "description": "JSON pointer to tool name (single-call)"
        },
        "json_pointer_args": {
          "type": "string",
          "pattern": "^(/arguments|/calls/\\d+/arguments)$",
          "description": "JSON pointer to arguments (single-call)"
        },
        "json_pointers": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^/calls/\\d+/arguments$"
          },
          "description": "JSON pointers for multi-call arguments"
        },
        "integration_spans_bytes": {
          "type": "array",
          "items": {
            "type": "array",
            "items": {"type": "integer"},
            "minItems": 2,
            "maxItems": 2
          },
          "description": "Integration spans [[start0, end0], [start1, end1], ...]"
        },
        "tool_result_fields": {
          "type": "object",
          "additionalProperties": {"type": "string"},
          "description": "Flattened tool result fields for grounding checks"
        }
      }
    }
  }
}

